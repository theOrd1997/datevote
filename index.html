<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>날짜 및 시간 투표</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 2rem;
      background: #f4f4f4;
      color: #333;
    }
    .container {
      background: #fff;
      padding: 2rem;
      max-width: 800px;
      margin: auto;
      border-radius: 12px;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.08);
    }
    input[type="text"] {
      padding: 0.5rem;
      font-size: 1rem;
      width: 100%;
      margin-bottom: 1rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      padding: 0.7rem;
      width: 100%;
      font-size: 1rem;
      background-color: #5a67d8;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .day-block {
      margin-bottom: 1.5rem;
      border-bottom: 1px solid #eee;
      padding-bottom: 1rem;
    }
    .day-title {
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    .slot-label {
      display: block;
      margin: 0.2rem 0;
      padding-left: 1rem;
    }
    .slot-names {
      font-size: 0.85rem;
      color: #666;
      padding-left: 2rem;
    }
    .over-three-block {
      margin-top: 2rem;
      padding: 1rem;
      background: #eefaf0;
      border: 1px solid #bde0c5;
      border-radius: 8px;
    }
  </style>
</head>
<body>
<div class="container">
  <h2>밥 먹기 가능한 날짜 및 시간을 선택</h2>
  <form id="voteForm">
    <label for="name">이름을 입력하세요:</label>
    <input type="text" id="name" name="name" required placeholder="예: 홍길동">

    <div id="checkboxContainer"></div>

    <button id="submitBtn" type="submit">제출하기</button>
    <span id="submitStatus"></span>
  </form>

  <div class="over-three-block">
    <h3>✅ 3명 이상 투표한 날짜/시간</h3>
    <ul id="overThreeList"></ul>
  </div>
</div>

<script>
  const dateList = [
    "6월 30일(월)", "7월 1일(화)", "7월 2일(수)", "7월 3일(목)", "7월 4일(금)",
    "7월 5일(토)", "7월 7일(월)", "7월 8일(화)", "7월 9일(수)",
    "7월 10일(목)", "7월 11일(금)", "7월 12일(토)"
  ];
  const timeList = ["오후 4시", "오후 5시", "오후 6시", "오후 7시", "오후 8시", "오후 9시"];
  const slotMap = {};

  const container = document.getElementById("checkboxContainer");
  dateList.forEach(date => {
    const dayBlock = document.createElement("div");
    dayBlock.className = "day-block";

    const title = document.createElement("div");
    title.className = "day-title";
    title.innerText = date;
    dayBlock.appendChild(title);

    timeList.forEach(time => {
      const value = `${date} - ${time}`;
      const label = document.createElement("label");
      label.className = "slot-label";
      label.innerHTML = `<input type="checkbox" name="slots" value="${value}"> ${time}`;

      const nameList = document.createElement("div");
      nameList.className = "slot-names";
      nameList.id = `names-${value}`;
      label.appendChild(nameList);

      dayBlock.appendChild(label);
      slotMap[value] = nameList;
    });

    container.appendChild(dayBlock);
  });

  const scriptUrl = 'https://script.google.com/macros/s/AKfycbwWfQoH2tOj1BKka2yu9edbFyUv7ZathfKnSwS6CpTGpwDa-5l0raDgMHLbz4OOnT0l/exec';

  document.getElementById("voteForm").addEventListener("submit", async e => {
    e.preventDefault();
    const name = document.getElementById("name").value.trim();
    const selected = [...document.querySelectorAll("input[name='slots']:checked")].map(el => el.value);
    const submitBtn = document.getElementById("submitBtn");
    const statusText = document.getElementById("submitStatus");

    if (!name) return alert("이름을 입력해주세요.");
    if (selected.length === 0) return alert("최소 한 항목을 선택해주세요.");

    submitBtn.disabled = true;
    submitBtn.textContent = "제출 중...";
    statusText.textContent = "서버에 저장 중입니다...";

    try {
      await fetch(scriptUrl, {
        method: 'POST',
        body: JSON.stringify({ name, slots: selected })
      });

      statusText.textContent = "제출 완료되었습니다.";
      updateSlots(name);
    } catch (error) {
      statusText.textContent = "⚠️ 제출 실패. 다시 시도해주세요.";
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "제출하기";
      setTimeout(() => { statusText.textContent = ""; }, 3000);
    }
  });

  async function updateSlots(currentName = "") {
    const res = await fetch(scriptUrl);
    const result = await res.json();
    const slotToNames = result.slotToNames || {};
    const overThree = result.overThree || [];

    // 각 슬롯 위에 이름 표시 및 본인 체크
    Object.keys(slotMap).forEach(slot => {
      const names = slotToNames[slot] || [];
      slotMap[slot].textContent = names.length ? `참여자: ${names.join(", ")}` : "";

      const checkbox = document.querySelector(`input[value="${slot}"]`);
      if (checkbox) {
        checkbox.checked = names.includes(currentName);
      }
    });

    // 3명 이상 항목 출력
    const list = document.getElementById("overThreeList");
    list.innerHTML = "";
    overThree.forEach(slot => {
      const li = document.createElement("li");
      li.textContent = slot;
      list.appendChild(li);
    });
  }

  updateSlots();
</script>
</body>
</html>
